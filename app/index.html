<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>待办事项</title>
    <link href="./css/mui.min.css" rel="stylesheet" />
    <link href="./css/tailwind.min.css" rel="stylesheet" />
    <script src="./js/mui.min.js"></script>
    <style>
        /* JetBrainsMonoNL-Regular  */
        @font-face {
            font-family: 'JetBrainsMonoNL-Regular';
            src: url('./fonts/JetBrainsMonoNL-Regular.ttf') format('tff');
        }

        :root {
            --ios-orange: rgb(255, 149, 0);
            --ios-border: rgb(209, 209, 214);
            --ios-gray: rgb(142, 142, 147);
            --ios-bg: rgb(242, 242, 247);
            font-family: 'JetBrainsMonoNL-Regular', sans-serif;
        }

        /* iOS风格底部导航 */
        .ios-tabbar {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid var(--ios-border);
        }

        .ios-tabbar-item {
            color: var(--ios-gray);
            transition: all 0.2s ease;
        }

        .ios-tabbar-item.active {
            color: var(--ios-orange);
        }

        .ios-tabbar-item:active {
            opacity: 0.7;
        }
    </style>
</head>

<body class="bg-[--ios-bg]">
<!-- Footer -->
<nav class="fixed bottom-0 left-0 right-0 h-14 ios-tabbar z-50 flex items-center justify-around px-4">
    <a class="ios-tabbar-item active flex flex-col items-center" data-page="todo">
        <span class="mui-icon mui-icon-checkmarkempty text-xl"></span>
        <span class="text-xs mt-0.5">待办</span>
    </a>
    <a class="ios-tabbar-item flex flex-col items-center" data-page="settings">
        <span class="mui-icon mui-icon-gear text-xl"></span>
        <span class="text-xs mt-0.5">设置</span>
    </a>
</nav>

<script type="text/javascript">
    // 初始化
    mui.init({
        swipeBack: false,
        gestureConfig: {
            tap: true,
            doubletap: false,
            longtap: false,
            hold: false,
            release: false,
        },
        beforeback: function() {
            // 返回时关闭所有子窗口
            const currentView = plus.webview.currentWebview();
            const children = currentView.children();
            children.forEach(child => {
                child.close("auto");
            });
            return true;
        },
    });

    // 阻止iOS橡皮筋效果
    document.body.addEventListener("touchmove", function(e) {
        if (e.cancelable) {
            e.preventDefault();
        }
    }, {
        passive: false,
    });

    // 等待加载完毕
    mui.plusReady(function() {
        // 获取当前窗口对象
        const currentView = plus.webview.currentWebview();

        // 预加载所有子页面
        const subpages = [{
            url: "./pages/todo.html",
            id: "todo",
            styles: {
                top: "0px",
                bottom: "50px",
                bounce: "vertical",
            },
        }, {
            url: "./pages/settings.html",
            id: "settings",
            styles: {
                top: "0px",
                bottom: "50px",
                bounce: "vertical",
            },
        }];

        // 创建子页面
        const createSubpage = (options) => {
            const subpage = plus.webview.create(
                options.url,
                options.id,
                options.styles,
            );
            // 添加到当前窗口
            currentView.append(subpage);
            return subpage;
        };

        // 预加载页面
        const preloadPages = () => {
            const views = {};
            subpages.forEach(options => {
                views[options.id] = createSubpage(options);
            });
            // 默认显示todo页面
            views.todo.show("pop-in");
            return views;
        };

        // 初始化页面
        const views = preloadPages();

        // 底部导航切换
        mui(".ios-tabbar").on("tap", ".ios-tabbar-item", function() {
            const pageId = this.dataset.page;
            if (!pageId || !views[pageId]) return;

            // 更新导航项状态
            document.querySelectorAll(".ios-tabbar-item").forEach(i => i.classList.remove("active"));
            this.classList.add("active");

            // 使用原生动画切换页面
            const showPage = (page) => {
                page.show("pop-in", 200, () => {
                    // 触觉反馈
                    if (plus.os.name === "iOS") {
                        plus.device.vibrate();
                    }
                });
            };

            const hidePage = (page) => {
                page.hide("pop-out", 200);
            };

            // 切换页面
            Object.entries(views).forEach(([id, view]) => {
                if (id === pageId) {
                    showPage(view);
                } else {
                    hidePage(view);
                }
            });
        });

        // 监听页面显示/隐藏事件
        Object.values(views).forEach(view => {
            view.addEventListener("show", () => {
                console.log(`页面显示: ${view.id}`);
                // 可以在这里处理页面显示后的逻辑
            });

            view.addEventListener("hide", () => {
                console.log(`页面隐藏: ${view.id}`);
                // 可以在这里处理页面隐藏后的逻辑
            });
        });
    });
</script>
</body>

</html>